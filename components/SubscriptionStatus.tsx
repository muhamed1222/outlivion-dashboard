'use client'

import { getSubscriptionStatus, getPlanName, formatExpiryDate, type UserSubscription } from '@/lib/subscription'
import { Card, CardContent, CardHeader, CardTitle } from './ui/Card'
import { cn } from '@/lib/utils'

interface SubscriptionStatusProps {
  user: UserSubscription
  className?: string
}

function getDayWord(days: number): string {
  const lastDigit = days % 10
  const lastTwoDigits = days % 100
  
  if (lastTwoDigits >= 11 && lastTwoDigits <= 14) return '–¥–Ω–µ–π'
  if (lastDigit === 1) return '–¥–µ–Ω—å'
  if (lastDigit >= 2 && lastDigit <= 4) return '–¥–Ω—è'
  return '–¥–Ω–µ–π'
}

export function SubscriptionStatus({ user, className }: SubscriptionStatusProps) {
  const status = getSubscriptionStatus(user)
  
  const getBadgeColor = () => {
    if (status.isExpired) return 'bg-rose-100 text-rose-700'
    if (status.isTrial) return 'bg-yellow-100 text-yellow-700'
    if (status.daysRemaining <= 3) return 'bg-orange-100 text-orange-700'
    return 'bg-green-100 text-green-700'
  }
  
  const getIcon = () => {
    if (status.isExpired) return '‚ùå'
    if (status.isTrial) return 'üéÅ'
    if (status.daysRemaining <= 3) return '‚ö†Ô∏è'
    return '‚úÖ'
  }
  
  const getStatusText = () => {
    if (status.isExpired) return '–ò—Å—Ç–µ–∫–ª–∞'
    if (status.isTrial) return '–ü—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥'
    if (status.daysRemaining <= 3) return '–ò—Å—Ç–µ–∫–∞–µ—Ç —Å–∫–æ—Ä–æ'
    return '–ê–∫—Ç–∏–≤–Ω–∞'
  }

  return (
    <Card className={cn('', className)}>
      <CardHeader className="pb-3">
        <div className="flex items-center justify-between">
          <CardTitle className="text-base font-semibold text-foreground">
            –ü–æ–¥–ø–∏—Å–∫–∞
          </CardTitle>
          <span className={cn('rounded-pill px-3 py-1 text-xs font-medium', getBadgeColor())}>
            {getIcon()} {getStatusText()}
          </span>
        </div>
      </CardHeader>
      <CardContent className="space-y-4">
        <div className="space-y-2">
          <div className="flex justify-between text-sm">
            <span className="text-foreground-muted">–¢–∞—Ä–∏—Ñ</span>
            <span className="font-medium text-foreground">{getPlanName(status.plan)}</span>
          </div>
          
          {status.expiresAt && (
            <>
              <div className="flex justify-between text-sm">
                <span className="text-foreground-muted">–î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ</span>
                <span className="font-medium text-foreground">
                  {formatExpiryDate(status.expiresAt)}
                </span>
              </div>
              
              {status.isActive && (
                <div className="flex justify-between text-sm">
                  <span className="text-foreground-muted">–û—Å—Ç–∞–ª–æ—Å—å –¥–Ω–µ–π</span>
                  <span className="font-medium text-foreground">{status.daysRemaining}</span>
                </div>
              )}
            </>
          )}
        </div>
        
        {status.isExpired && (
          <div className="rounded-card bg-rose-50 px-4 py-3 text-sm text-rose-600">
            –ü—Ä–æ–¥–ª–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —Å–µ—Ä–≤–∏—Å–æ–º
          </div>
        )}
        
        {status.isTrial && (
          <div className="rounded-card bg-yellow-50 px-4 py-3 text-sm text-yellow-700">
            {status.isActive 
              ? `–£ –≤–∞—Å ${status.daysRemaining} ${getDayWord(status.daysRemaining)} –ø—Ä–æ–±–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞`
              : '–ü—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –∑–∞–∫–æ–Ω—á–∏–ª—Å—è'}
          </div>
        )}
        
        {!status.isExpired && !status.isTrial && status.daysRemaining <= 3 && (
          <div className="rounded-card bg-orange-50 px-4 py-3 text-sm text-orange-700">
            –ü–æ–¥–ø–∏—Å–∫–∞ —Å–∫–æ—Ä–æ –∏—Å—Ç–µ—á–µ—Ç. –ü—Ä–æ–¥–ª–∏—Ç–µ –µ—ë —Å–µ–π—á–∞—Å, —á—Ç–æ–±—ã –Ω–µ –ø–æ—Ç–µ—Ä—è—Ç—å –¥–æ—Å—Ç—É–ø.
          </div>
        )}
      </CardContent>
    </Card>
  )
}

