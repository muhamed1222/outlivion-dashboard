# –†–µ–∑—é–º–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å–∏—Å—Ç–µ–º—ã –ø–æ–¥–ø–∏—Å–æ–∫

## üì¶ –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (3 —Ñ–∞–π–ª–∞)
1. `supabase/add_subscription_system.sql` - –°—Ö–µ–º–∞ –ø–æ–¥–ø–∏—Å–æ–∫
2. `supabase/check_expired_subscriptions.sql` - –§—É–Ω–∫—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏—Å—Ç–µ—á–µ–Ω–∏—è
3. ‚úÖ (—É–∂–µ –±—ã–ª) `supabase/cleanup_expired_tokens_function.sql` - –û—á–∏—Å—Ç–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤

### Backend (4 —Ñ–∞–π–ª–∞)
4. `lib/subscription.ts` - **–ù–û–í–´–ô** - –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ–¥–ø–∏—Å–∫–∞–º–∏
5. `app/api/auth/verify-token/route.ts` - **–û–ë–ù–û–í–õ–ï–ù** - Trial –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
6. `app/api/payment/create/route.ts` - **–û–ë–ù–û–í–õ–ï–ù** - –ü–µ—Ä–µ–¥–∞—á–∞ telegram_id
7. `app/api/payment/webhook/route.ts` - **–û–ë–ù–û–í–õ–ï–ù** - –ü—Ä–æ–¥–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏
8. `app/api/subscription/check/route.ts` - **–ù–û–í–´–ô** - API –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö

### Frontend (2 —Ñ–∞–π–ª–∞)
9. `components/SubscriptionStatus.tsx` - **–ù–û–í–´–ô** - –ö–æ–º–ø–æ–Ω–µ–Ω—Ç —Å—Ç–∞—Ç—É—Å–∞
10. `app/(dashboard)/dashboard/page.tsx` - **–û–ë–ù–û–í–õ–ï–ù** - –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏

### Telegram Bot (1 —Ñ–∞–π–ª)
11. `telegram-bot/bot.py` - **–û–ë–ù–û–í–õ–ï–ù** - –ö–æ–º–∞–Ω–¥–∞ /subscription

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (2 —Ñ–∞–π–ª–∞)
12. `MOBILE_API.md` - **–ù–û–í–´–ô** - API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
13. `INTEGRATION_COMPLETE.md` - **–ù–û–í–´–ô** - –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é

---

## üîß –ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### 1. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
```sql
-- –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ plan
ALTER TABLE users ADD COLUMN plan TEXT DEFAULT 'trial';

-- –î–æ–±–∞–≤–ª–µ–Ω metadata –¥–ª—è –ø–ª–∞—Ç–µ–∂–µ–π
ALTER TABLE payments ADD COLUMN metadata JSONB DEFAULT '{}'::jsonb;

-- –°–æ–∑–¥–∞–Ω–∞ view –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫
CREATE VIEW active_subscriptions AS ...;

-- –§—É–Ω–∫—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏—Å—Ç–µ—á–µ–Ω–∏—è
CREATE FUNCTION check_expired_subscriptions() ...;
CREATE FUNCTION get_expiring_soon_subscriptions() ...;
```

### 2. –¢–∏–ø—ã –ø–æ–¥–ø–∏—Å–æ–∫
- `trial` - 7 –¥–Ω–µ–π, –±–µ—Å–ø–ª–∞—Ç–Ω–æ
- `month` - 1 –º–µ—Å—è—Ü, 199 ‚ÇΩ
- `halfyear` - 6 –º–µ—Å—è—Ü–µ–≤, 999 ‚ÇΩ
- `year` - 1 –≥–æ–¥, 1999 ‚ÇΩ
- `expired` - –ò—Å—Ç–µ–∫–ª–∞

### 3. –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è

#### –ü—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (verify-token):
```typescript
plan: 'trial',
subscription_expires: NOW() + 7 days,
balance: 0
```

#### –ü—Ä–∏ –æ–ø–ª–∞—Ç–µ (payment webhook):
```typescript
// –ü–æ–ª—É—á–∞–µ–º plan_type –∏–∑ metadata
// –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –Ω–æ–≤—ã–π subscription_expires
// –û–±–Ω–æ–≤–ª—è–µ–º plan –∏ subscription_expires
// –°–æ–∑–¥–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
```

#### API –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö (subscription check):
```typescript
GET /api/subscription/check?telegram_id=123456789
// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª–Ω—ã–π —Å—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏
```

---

## üìã –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è

### –®–∞–≥ 1: –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö ‚ö†Ô∏è –í–ê–ñ–ù–û
```bash
# –û—Ç–∫—Ä–æ–π—Ç–µ Supabase Dashboard ‚Üí SQL Editor
# –í—ã–ø–æ–ª–Ω–∏—Ç–µ –ø–æ –ø–æ—Ä—è–¥–∫—É:
1. supabase/add_subscription_system.sql
2. supabase/check_expired_subscriptions.sql
```

### –®–∞–≥ 2: –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å –∑–∞–Ω–æ–≤–æ
npm run dev
```

### –®–∞–≥ 3: –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞
```bash
cd telegram-bot
python bot.py
```

### –®–∞–≥ 4: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
```bash
# 1. –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –æ—Ç–ø—Ä–∞–≤–∏—Ç—å /start –≤ –±–æ—Ç
# 2. –í–æ–π—Ç–∏ –Ω–∞ dashboard - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å trial
# 3. –û—Ç–ø—Ä–∞–≤–∏—Ç—å /subscription –≤ –±–æ—Ç
# 4. –ü—Ä–æ–≤–µ—Å—Ç–∏ —Ç–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂
# 5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ–¥–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏
```

---

## ‚úÖ –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª

### –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ
- ‚úÖ Trial 7 –¥–Ω–µ–π –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
- ‚úÖ 3 —Ç–∏–ø–∞ –ø–ª–∞—Ç–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ
- ‚úÖ –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –≤ Dashboard
- ‚úÖ –ö–æ–º–∞–Ω–¥–∞ /subscription –≤ –±–æ—Ç–µ
- ‚úÖ API –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è
- ‚úÖ –ü–µ—Ä–µ–¥–∞—á–∞ telegram_id –≤ –ø–ª–∞—Ç–µ–∂–∞—Ö

### –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ—Ç–æ–º
- ‚ö™ –°—Ç—Ä–∞–Ω–∏—Ü–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–æ–π
- ‚ö™ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∑–∞ 3 –¥–Ω—è –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è
- ‚ö™ Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- ‚ö™ –ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π
- ‚ö™ –û—Ç–º–µ–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∏

---

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏

### –ü—Ä–æ–≤–µ—Ä–∫–∞ 1: –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
```sql
SELECT plan, COUNT(*) FROM users GROUP BY plan;
-- –î–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å trial

SELECT * FROM active_subscriptions LIMIT 5;
-- View –¥–æ–ª–∂–Ω–∞ —Ä–∞–±–æ—Ç–∞—Ç—å
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ 2: Dashboard
- –í–æ–π—Ç–∏ ‚Üí –£–≤–∏–¥–µ—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É "–ü–æ–¥–ø–∏—Å–∫–∞"
- –°—Ç–∞—Ç—É—Å "–ü—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥"
- –ö–Ω–æ–ø–∫–∞ "–û—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É"

### –ü—Ä–æ–≤–µ—Ä–∫–∞ 3: –ë–æ—Ç
```
/subscription ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ 4: API
```bash
curl http://localhost:3000/api/subscription/check?telegram_id=123456789
```

---

## üìû –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. **–ë–∞–∑–∞ –Ω–µ –æ–±–Ω–æ–≤–∏–ª–∞—Å—å** ‚Üí –í—ã–ø–æ–ª–Ω–∏—Ç–µ SQL —Å–∫—Ä–∏–ø—Ç—ã
2. **Dashboard –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É** ‚Üí –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ `npm run dev`
3. **–ë–æ—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ /subscription** ‚Üí –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞
4. **Webhook –Ω–µ –ø—Ä–æ–¥–ª–µ–≤–∞–µ—Ç** ‚Üí –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ webhook
5. **API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 404** ‚Üí –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

---

## üìä –°—Ö–µ–º–∞ –¥–∞–Ω–Ω—ã—Ö

```
users {
  id: uuid (PK)
  telegram_id: bigint (unique)
  plan: text ('trial', 'month', 'halfyear', 'year', 'expired')
  subscription_expires: timestamp
  balance: decimal
}

payments {
  id: uuid (PK)
  user_id: uuid (FK)
  amount: decimal
  method: text
  status: text
  metadata: jsonb {
    telegram_id: bigint,
    plan_type: text,
    plan_name: text
  }
}
```

---

## üéØ –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∞–π–ª—ã –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞

1. **Subscription logic**: `lib/subscription.ts`
2. **Trial on signup**: `app/api/auth/verify-token/route.ts` (—Å—Ç—Ä–æ–∫–∏ 223-258)
3. **Payment renewal**: `app/api/payment/webhook/route.ts` (—Å—Ç—Ä–æ–∫–∏ 105-130)
4. **Mobile API**: `app/api/subscription/check/route.ts`
5. **Dashboard UI**: `components/SubscriptionStatus.tsx`
6. **Bot command**: `telegram-bot/bot.py` (—Å—Ç—Ä–æ–∫–∏ 161-251)

---

## üöÄ –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!

–í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–æ–∑–¥–∞–Ω—ã –∏ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã. –ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è SQL —Å–∫—Ä–∏–ø—Ç–æ–≤ –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —Å–∏—Å—Ç–µ–º–∞ –±—É–¥–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞.

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥**: –°–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º –≤ `INTEGRATION_COMPLETE.md`

