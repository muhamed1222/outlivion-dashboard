#!/bin/bash

echo "üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò"
echo "======================================"
echo ""

# –ü–æ–ª—É—á–∞–µ–º —Å–≤–µ–∂–∏–π —Ç–æ–∫–µ–Ω –∏–∑ –±–∞–∑—ã
echo "1Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Ç–æ–∫–µ–Ω—ã –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö..."
echo "–í—ã–ø–æ–ª–Ω–∏—Ç–µ —ç—Ç–æ—Ç SQL –≤ Supabase –∏ –≤—Å—Ç–∞–≤—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç:"
echo ""
cat << 'EOF'
SELECT 
  token,
  telegram_id,
  used,
  expires_at,
  (expires_at > NOW()) as is_valid,
  created_at
FROM auth_tokens
WHERE telegram_id = 782245481
  AND used = false
  AND expires_at > NOW()
ORDER BY created_at DESC
LIMIT 1;
EOF
echo ""
echo "======================================"
echo ""

read -p "–í—Å—Ç–∞–≤—å—Ç–µ —Ç–æ–∫–µ–Ω –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ SQL: " TOKEN

if [ -z "$TOKEN" ]; then
    echo "‚ùå –¢–æ–∫–µ–Ω –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω"
    exit 1
fi

echo ""
echo "2Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω —á–µ—Ä–µ–∑ API..."
echo "Token: $TOKEN"
echo ""

RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "https://outliviondashboard.vercel.app/api/auth/verify-token" \
  -H "Content-Type: application/json" \
  -d "{\"token\":\"$TOKEN\"}")

HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
BODY=$(echo "$RESPONSE" | sed '$d')

echo "HTTP Status: $HTTP_CODE"
echo "Response:"
echo "$BODY" | jq '.' 2>/dev/null || echo "$BODY"
echo ""

if [ "$HTTP_CODE" = "200" ]; then
    echo "‚úÖ API —Ä–∞–±–æ—Ç–∞–µ—Ç!"
    echo ""
    echo "3Ô∏è‚É£ –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–ª–Ω—É—é –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é..."
    echo "–û—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ:"
    echo "https://outliviondashboard.vercel.app/auth/login?token=$TOKEN"
elif [ "$HTTP_CODE" = "401" ]; then
    echo "‚ùå –¢–æ–∫–µ–Ω –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π –∏–ª–∏ –∏—Å—Ç–µ–∫"
elif [ "$HTTP_CODE" = "500" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Vercel"
fi

echo ""
echo "======================================"

