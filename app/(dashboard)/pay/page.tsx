'use client'

import { useState, useEffect, useCallback } from 'react'
import { createClient } from '@/lib/supabase/client'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/Card'
import { Button } from '@/components/ui/Button'
import { formatCurrency } from '@/lib/utils'

type Plan = {
  id: string
  name: string
  price: number
  duration_days: number
}

type PaymentMethod = 'card' | 'sbp' | 'promo'

export default function PayPage() {
  const [plans, setPlans] = useState<Plan[]>([])
  const [selectedPlan, setSelectedPlan] = useState<string | null>(null)
  const [paymentMethod, setPaymentMethod] = useState<PaymentMethod>('card')
  const [isLoading, setIsLoading] = useState(false)
  const [error, setError] = useState<string | null>(null)

  const supabase = createClient()

  const fetchPlans = useCallback(async () => {
    const { data, error } = await supabase
      .from('plans')
      .select('*')
      .order('price', { ascending: true })

    if (error) {
      console.error('Error fetching plans:', error)
      return
    }

    setPlans(data || [])
    if (data && data.length > 0) {
      setSelectedPlan(data[0].id)
    }
  }, [supabase])

  useEffect(() => {
    fetchPlans()
  }, [fetchPlans])

  const handlePayment = async () => {
    if (!selectedPlan) return

    setIsLoading(true)
    setError(null)

    try {
      const { data: { user } } = await supabase.auth.getUser()

      if (!user) {
        throw new Error('–ù–µ–æ–±—Ö–æ–¥–∏–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è')
      }

      const response = await fetch('/api/payment/create', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          plan_id: selectedPlan,
          user_id: user.id,
          method: paymentMethod,
        }),
      })

      if (!response.ok) {
        throw new Error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞')
      }

      const { payment_url } = await response.json()

      // –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–ø–ª–∞—Ç—ã
      if (payment_url) {
        window.location.href = payment_url
      }
    } catch (err) {
      console.error('Payment error:', err)
      setError(err instanceof Error ? err.message : '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞')
    } finally {
      setIsLoading(false)
    }
  }

  const selectedPlanData = plans.find(p => p.id === selectedPlan)

  return (
    <div className="max-w-4xl mx-auto space-y-6">
      <div>
        <h1 className="text-3xl font-bold mb-2">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞</h1>
        <p className="text-white/60">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞—Ä–∏—Ñ –∏ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</p>
      </div>

      {error && (
        <div className="p-4 rounded-lg bg-red-500/10 border border-red-500/20 text-red-400">
          {error}
        </div>
      )}

      {/* –í—ã–±–æ—Ä —Ç–∞—Ä–∏—Ñ–∞ */}
      <Card>
        <CardHeader>
          <CardTitle>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞—Ä–∏—Ñ</CardTitle>
          <CardDescription>–í—Å–µ —Ç–∞—Ä–∏—Ñ—ã –≤–∫–ª—é—á–∞—é—Ç –±–µ–∑–ª–∏–º–∏—Ç–Ω—ã–π —Ç—Ä–∞—Ñ–∏–∫</CardDescription>
        </CardHeader>
        <CardContent>
          <div className="grid gap-4 md:grid-cols-3">
            {plans.map((plan) => (
              <button
                key={plan.id}
                onClick={() => setSelectedPlan(plan.id)}
                className={`p-6 rounded-lg border-2 transition-all text-left ${
                  selectedPlan === plan.id
                    ? 'border-accent bg-accent/10'
                    : 'border-white/10 hover:border-white/20'
                }`}
              >
                <h3 className="text-xl font-bold mb-2">{plan.name}</h3>
                <div className="text-3xl font-bold text-accent mb-1">
                  {formatCurrency(plan.price)}
                </div>
                <p className="text-sm text-white/60">
                  {plan.duration_days} {plan.duration_days === 30 ? '–¥–Ω–µ–π' : '–¥–Ω–µ–π'}
                </p>
                {plan.duration_days === 365 && (
                  <div className="mt-2 inline-block px-2 py-1 bg-green-500/20 text-green-400 text-xs rounded">
                    –í—ã–≥–æ–¥–Ω–æ!
                  </div>
                )}
              </button>
            ))}
          </div>
        </CardContent>
      </Card>

      {/* –°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã */}
      <Card>
        <CardHeader>
          <CardTitle>–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="space-y-3">
            <button
              onClick={() => setPaymentMethod('card')}
              className={`w-full p-4 rounded-lg border-2 transition-all flex items-center gap-3 ${
                paymentMethod === 'card'
                  ? 'border-accent bg-accent/10'
                  : 'border-white/10 hover:border-white/20'
              }`}
            >
              <div className="text-2xl">üí≥</div>
              <div className="text-left">
                <div className="font-semibold">–ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞</div>
                <div className="text-sm text-white/60">Visa, Mastercard, –ú–ò–†</div>
              </div>
            </button>

            <button
              onClick={() => setPaymentMethod('sbp')}
              className={`w-full p-4 rounded-lg border-2 transition-all flex items-center gap-3 ${
                paymentMethod === 'sbp'
                  ? 'border-accent bg-accent/10'
                  : 'border-white/10 hover:border-white/20'
              }`}
            >
              <div className="text-2xl">üì±</div>
              <div className="text-left">
                <div className="font-semibold">–°–∏—Å—Ç–µ–º–∞ –±—ã—Å—Ç—Ä—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π (–°–ë–ü)</div>
                <div className="text-sm text-white/60">–û–ø–ª–∞—Ç–∞ –ø–æ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞</div>
              </div>
            </button>

            <button
              onClick={() => setPaymentMethod('promo')}
              className={`w-full p-4 rounded-lg border-2 transition-all flex items-center gap-3 ${
                paymentMethod === 'promo'
                  ? 'border-accent bg-accent/10'
                  : 'border-white/10 hover:border-white/20'
              }`}
            >
              <div className="text-2xl">üéÅ</div>
              <div className="text-left">
                <div className="font-semibold">–ü—Ä–æ–º–æ–∫–æ–¥</div>
                <div className="text-sm text-white/60">–ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞</div>
              </div>
            </button>
          </div>
        </CardContent>
      </Card>

      {/* –ò—Ç–æ–≥–æ */}
      <Card>
        <CardContent className="pt-6">
          <div className="flex items-center justify-between mb-4">
            <div>
              <div className="text-sm text-white/60 mb-1">–ö –æ–ø–ª–∞—Ç–µ</div>
              <div className="text-3xl font-bold">
                {selectedPlanData ? formatCurrency(selectedPlanData.price) : '‚Äî'}
              </div>
            </div>
            <Button
              onClick={handlePayment}
              size="lg"
              isLoading={isLoading}
              disabled={!selectedPlan}
            >
              –ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ
            </Button>
          </div>
          <p className="text-xs text-white/40">
            –ù–∞–∂–∏–º–∞—è –∫–Ω–æ–ø–∫—É, –≤—ã —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å —Å —É—Å–ª–æ–≤–∏—è–º–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞
          </p>
        </CardContent>
      </Card>
    </div>
  )
}

