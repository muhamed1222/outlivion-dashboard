# YooKassa Integration Testing Guide

## –û–±–∑–æ—Ä

–≠—Ç–æ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ YooKassa payment gateway.

## –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞

### 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è

#### –ü–æ–ª—É—á–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ credentials –æ—Ç YooKassa

1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ https://yookassa.ru/
2. –í–æ–π—Ç–∏ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç
3. **–í–∞–∂–Ω–æ**: –í–∫–ª—é—á–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω)
4. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è ‚Üí –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å:
   - Shop ID
   - Secret Key

#### –î–æ–±–∞–≤–∏—Ç—å –≤ `.env.local`

```env
# YooKassa Test Credentials
YOOKASSA_SHOP_ID=your_test_shop_id
YOOKASSA_SECRET_KEY=your_test_secret_key
ENABLE_YOOKASSA=true
```

### 2. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

```bash
# –ß–µ—Ä–µ–∑ Supabase Dashboard SQL Editor
# –í—ã–ø–æ–ª–Ω–∏—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ supabase/add_payment_gateway_fields.sql
```

–ò–ª–∏ —á–µ—Ä–µ–∑ psql:
```bash
psql -h <SUPABASE_HOST> -U postgres -d postgres -f supabase/add_payment_gateway_fields.sql
```

### 3. –ó–∞–ø—É—Å—Ç–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä

```bash
npm run dev
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–µ—Å—Ç (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

```bash
./test_scripts/test_yookassa.sh
```

–°–∫—Ä–∏–ø—Ç –≤—ã–ø–æ–ª–Ω–∏—Ç:
1. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫—É environment variables
2. üîÑ –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞
3. üåê –û—Ç–∫—Ä—ã—Ç–∏–µ payment URL –≤ –±—Ä–∞—É–∑–µ—Ä–µ
4. üìä –í—ã–≤–æ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

### –í–∞—Ä–∏–∞–Ω—Ç 2: Manual Testing

#### Step 1: –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞—Ç—ë–∂

```bash
curl -X POST http://localhost:3000/api/payment/create \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": "YOUR_USER_UUID",
    "plan_id": "YOUR_PLAN_UUID",
    "method": "card",
    "gateway": "yookassa",
    "plan_type": "month"
  }'
```

–û–∂–∏–¥–∞–µ–º—ã–π response:
```json
{
  "payment_url": "https://yookassa.ru/checkout/payments/...",
  "payment_id": "uuid",
  "gateway": "yookassa"
}
```

#### Step 2: –ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞—Ç—ë–∂

1. –û—Ç–∫—Ä—ã—Ç—å `payment_url` –∏–∑ response
2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –∫–∞—Ä—Ç—É:

| –ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã | CVV | –°—Ä–æ–∫ | –†–µ–∑—É–ª—å—Ç–∞—Ç |
|-------------|-----|------|-----------|
| `5555555555554477` | 123 | 12/25 | ‚úÖ –£—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞ |
| `5555555555554444` | 123 | 12/25 | ‚ùå –û—Ç–∫–ª–æ–Ω—ë–Ω–Ω—ã–π –ø–ª–∞—Ç—ë–∂ |

3. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–ª–∞—Ç—ë–∂

#### Step 3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å webhook

```bash
# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
npm run dev

# –ò–ª–∏ —á–µ—Ä–µ–∑ Vercel (–µ—Å–ª–∏ deployed)
vercel logs --follow
```

–û–∂–∏–¥–∞–µ–º—ã–µ –ª–æ–≥–∏:
```json
{
  "level": "info",
  "event_type": "webhook_received",
  "source": "yookassa_webhook",
  "payment_id": "...",
  "msg": "YooKassa webhook received"
}

{
  "level": "info",
  "event_type": "payment_completed",
  "source": "yookassa_webhook",
  "order_id": "...",
  "msg": "Payment marked as completed"
}

{
  "level": "info",
  "event_type": "subscription_extended",
  "source": "yookassa_webhook",
  "user_id": "...",
  "plan_type": "month",
  "msg": "Subscription extended via YooKassa"
}
```

#### Step 4: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö

```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–ª–∞—Ç—ë–∂
SELECT id, gateway, status, gateway_payment_id, amount
FROM payments
WHERE id = 'YOUR_PAYMENT_ID';

-- –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
-- gateway: 'yookassa'
-- status: 'completed'
-- gateway_payment_id: UUID –æ—Ç YooKassa

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏
SELECT id, plan, subscription_expires
FROM users
WHERE id = 'YOUR_USER_ID';

-- –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
-- plan: 'month'
-- subscription_expires: –¥–∞—Ç–∞ —á–µ—Ä–µ–∑ 30 –¥–Ω–µ–π

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
SELECT * FROM transactions
WHERE user_id = 'YOUR_USER_ID'
ORDER BY created_at DESC
LIMIT 1;

-- –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
-- type: 'subscription'
-- description: —Å–æ–¥–µ—Ä–∂–∏—Ç 'YooKassa'
```

### –í–∞—Ä–∏–∞–Ω—Ç 3: Frontend Testing

1. –û—Ç–∫—Ä—ã—Ç—å http://localhost:3000/pay
2. –í—ã–±—Ä–∞—Ç—å —Ç–∞—Ä–∏—Ñ
3. **–í–∞–∂–Ω–æ**: –í—ã–±—Ä–∞—Ç—å "–ÆKassa" –≤ —Å–µ–∫—Ü–∏–∏ "–ü–ª–∞—Ç—ë–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞"
4. –í—ã–±—Ä–∞—Ç—å —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã (card/sbp)
5. –ù–∞–∂–∞—Ç—å "–û–ø–ª–∞—Ç–∏—Ç—å"
6. –ó–∞–≤–µ—Ä—à–∏—Ç—å –ø–ª–∞—Ç—ë–∂ —Ç–µ—Å—Ç–æ–≤–æ–π –∫–∞—Ä—Ç–æ–π
7. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ `/payment/success`
8. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å dashboard - –ø–æ–¥–ø–∏—Å–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∞–∫—Ç–∏–≤–Ω–∞

## –¢–µ—Å—Ç–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –£—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞ –ø–æ–¥–ø–∏—Å–∫–∏ (month)

```bash
# –°–æ–∑–¥–∞—Ç—å –ø–ª–∞—Ç—ë–∂
curl -X POST http://localhost:3000/api/payment/create \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": "USER_UUID",
    "method": "card",
    "gateway": "yookassa",
    "plan_type": "month"
  }'

# –û–ø–ª–∞—Ç–∏—Ç—å –∫–∞—Ä—Ç–æ–π 5555555555554477

# –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
# ‚úÖ Payment status: completed
# ‚úÖ User plan: month
# ‚úÖ Subscription expires: current_date + 30 days
# ‚úÖ Transaction created with type: subscription
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –£—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞ –ø–æ–¥–ø–∏—Å–∫–∏ (halfyear)

```bash
# –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ —Å—Ü–µ–Ω–∞—Ä–∏—é 1, –Ω–æ:
# plan_type: "halfyear"

# –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
# ‚úÖ Subscription expires: current_date + 180 days
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –£—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞ –ø–æ–¥–ø–∏—Å–∫–∏ (year)

```bash
# –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ —Å—Ü–µ–Ω–∞—Ä–∏—é 1, –Ω–æ:
# plan_type: "year"

# –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
# ‚úÖ Subscription expires: current_date + 365 days
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 4: –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞

```bash
# –°–æ–∑–¥–∞—Ç—å –ø–ª–∞—Ç—ë–∂ –ë–ï–ó plan_type
curl -X POST http://localhost:3000/api/payment/create \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": "USER_UUID",
    "plan_id": "PLAN_UUID",  # –õ—é–±–æ–π –ø–ª–∞–Ω –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å—É–º–º—ã
    "method": "card",
    "gateway": "yookassa"
  }'

# –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
# ‚úÖ User balance —É–≤–µ–ª–∏—á–µ–Ω –Ω–∞ —Å—É–º–º—É –ø–ª–∞—Ç–µ–∂–∞
# ‚úÖ Transaction created with type: payment
# ‚úÖ Plan –Ω–µ –∏–∑–º–µ–Ω—ë–Ω
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 5: –û—Ç–∫–ª–æ–Ω—ë–Ω–Ω—ã–π –ø–ª–∞—Ç—ë–∂

```bash
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –∫–∞—Ä—Ç—É 5555555555554444

# –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
# ‚úÖ Payment status: failed
# ‚úÖ User subscription –ù–ï –∏–∑–º–µ–Ω–µ–Ω–∞
# ‚úÖ User balance –ù–ï –∏–∑–º–µ–Ω—ë–Ω
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 6: –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ Enot + YooKassa

```bash
# –°–æ–∑–¥–∞—Ç—å –ø–ª–∞—Ç—ë–∂ —á–µ—Ä–µ–∑ Enot
curl -X POST http://localhost:3000/api/payment/create \
  -d '{"gateway": "enot", ...}'

# –°–æ–∑–¥–∞—Ç—å –ø–ª–∞—Ç—ë–∂ —á–µ—Ä–µ–∑ YooKassa
curl -X POST http://localhost:3000/api/payment/create \
  -d '{"gateway": "yookassa", ...}'

# –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
# ‚úÖ –û–±–∞ –ø–ª–∞—Ç–µ–∂–∞ —Å–æ–∑–¥–∞—é—Ç—Å—è –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ
# ‚úÖ –û–±–∞ webhook –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
# ‚úÖ –í –ë–î —Ä–∞–∑–Ω—ã–µ gateway –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞
```

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –æ—Ç–ª–∞–¥–∫–∞

### –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤

#### –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞
```bash
# Terminal —Å npm run dev –ø–æ–∫–∞–∂–µ—Ç –≤—Å–µ structured logs
npm run dev
```

#### Production (Vercel)
```bash
# Real-time logs
vercel logs --follow

# Logs –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ deployment
vercel logs <deployment-url>

# –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ event_type
vercel logs --follow | grep yookassa
```

### –ü–æ–∏—Å–∫ –≤ –ª–æ–≥–∞—Ö

```bash
# –í—Å–µ YooKassa —Å–æ–±—ã—Ç–∏—è
vercel logs | grep '"source":"yookassa'

# –¢–æ–ª—å–∫–æ –æ—à–∏–±–∫–∏
vercel logs | grep '"level":"error"' | grep yookassa

# –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π payment
vercel logs | grep 'payment_id":"YOUR_PAYMENT_ID'
```

### –ú–µ—Ç—Ä–∏–∫–∏

```sql
-- Success rate YooKassa
SELECT 
  COUNT(*) FILTER (WHERE status = 'completed') * 100.0 / COUNT(*) as success_rate
FROM payments
WHERE gateway = 'yookassa';

-- –°—Ä–µ–¥–Ω—è—è —Å—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞
SELECT AVG(amount) as avg_amount
FROM payments
WHERE gateway = 'yookassa' AND status = 'completed';

-- –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –º–µ—Ç–æ–¥–∞–º
SELECT payment_method_type, COUNT(*)
FROM payments
WHERE gateway = 'yookassa'
GROUP BY payment_method_type;

-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ 10 –ø–ª–∞—Ç–µ–∂–µ–π
SELECT id, gateway, status, amount, created_at
FROM payments
WHERE gateway = 'yookassa'
ORDER BY created_at DESC
LIMIT 10;
```

## Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: 401 Unauthorized –æ—Ç YooKassa

**–ü—Ä–∏—á–∏–Ω–∞**: –ù–µ–≤–µ—Ä–Ω—ã–µ credentials –∏–ª–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

**–†–µ—à–µ–Ω–∏–µ**:
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `YOOKASSA_SHOP_ID` –∏ `YOOKASSA_SECRET_KEY`
2. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ credentials –∏–∑ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è (test/prod)
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç Basic Auth –≤ `lib/yookassa.ts`

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å credentials –≤—Ä—É—á–Ω—É—é
SHOP_ID="your_shop_id"
SECRET_KEY="your_secret_key"

curl -X POST https://api.yookassa.ru/v3/payments \
  -u "$SHOP_ID:$SECRET_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "amount": {"value": "100.00", "currency": "RUB"},
    "confirmation": {"type": "redirect", "return_url": "https://example.com"},
    "capture": true
  }'
```

### –ü—Ä–æ–±–ª–µ–º–∞: Webhook –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç

**–ü—Ä–∏—á–∏–Ω–∞**: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π URL –∏–ª–∏ webhook –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω

**–†–µ—à–µ–Ω–∏–µ**:
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å webhook URL –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ YooKassa
2. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ URL –ø—É–±–ª–∏—á–Ω–æ –¥–æ—Å—Ç—É–ø–µ–Ω (–Ω–µ localhost)
3. –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ngrok:

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å ngrok
brew install ngrok  # macOS

# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç—É–Ω–Ω–µ–ª—å
ngrok http 3000

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ngrok URL –≤ YooKassa webhook:
# https://xxxx-xx-xx-xxx-xxx.ngrok.io/api/payment/webhook/yookassa
```

### –ü—Ä–æ–±–ª–µ–º–∞: Payment —Å–æ–∑–¥–∞—ë—Ç—Å—è, –Ω–æ webhook –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫—É

**–ü—Ä–∏—á–∏–Ω–∞**: –û—à–∏–±–∫–∞ –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ webhook (–æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –ø–æ–ª—è –≤ –ë–î –∏ —Ç.–¥.)

**–†–µ—à–µ–Ω–∏–µ**:
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ webhook handler
2. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –º–∏–≥—Ä–∞—Ü–∏—è –ë–î –ø—Ä–∏–º–µ–Ω–µ–Ω–∞
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å structured logs:

```bash
vercel logs | grep '"source":"yookassa_webhook"' | grep '"level":"error"'
```

### –ü—Ä–æ–±–ª–µ–º–∞: ENABLE_YOOKASSA –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

**–ü—Ä–∏—á–∏–Ω–∞**: Feature flag –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–ª–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ

**–†–µ—à–µ–Ω–∏–µ**:
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ
echo $ENABLE_YOOKASSA

# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: true (—Å—Ç—Ä–æ–∫–∞, –Ω–µ boolean)

# –û–±–Ω–æ–≤–∏—Ç—å –≤ Vercel
vercel env rm ENABLE_YOOKASSA
vercel env add ENABLE_YOOKASSA
# –í–≤–µ—Å—Ç–∏: true

# Redeploy
vercel --prod
```

## Production Deployment

### –ß–µ–∫-–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º

- [ ] ‚úÖ SQL –º–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ –∫ production –ë–î
- [ ] ‚úÖ `YOOKASSA_SHOP_ID` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (production credentials)
- [ ] ‚úÖ `YOOKASSA_SECRET_KEY` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (production credentials)
- [ ] ‚úÖ `ENABLE_YOOKASSA=true` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
- [ ] ‚úÖ Webhook –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ YooKassa: `https://yourdomain.com/api/payment/webhook/yookassa`
- [ ] ‚úÖ Webhook events: `payment.succeeded`, `payment.canceled`
- [ ] ‚úÖ –¢–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞—Ç—ë–∂ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ –Ω–∞ staging
- [ ] ‚úÖ –õ–æ–≥–∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã - –Ω–µ—Ç –æ—à–∏–±–æ–∫
- [ ] ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –Ω–∞—Å—Ç—Ä–æ–µ–Ω

### –ü–æ—à–∞–≥–æ–≤—ã–π –¥–µ–ø–ª–æ–π

```bash
# 1. Commit –∏–∑–º–µ–Ω–µ–Ω–∏–π
git add .
git commit -m "feat: integrate YooKassa payment gateway"

# 2. Push –≤ main
git push origin main

# 3. Deploy –Ω–∞ Vercel
vercel --prod

# 4. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å webhook –≤ YooKassa
# URL: https://yourdomain.com/api/payment/webhook/yookassa

# 5. –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞—Ç—ë–∂ –≤ production
curl -X POST https://yourdomain.com/api/payment/create \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": "...",
    "method": "card",
    "gateway": "yookassa",
    "plan_type": "month"
  }'

# 6. –ó–∞–≤–µ—Ä—à–∏—Ç—å –ø–ª–∞—Ç—ë–∂ –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å webhook

# 7. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
vercel logs --follow
```

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### IP Whitelist (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

YooKassa –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç webhooks —Å –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö IP. –î–æ–±–∞–≤—å—Ç–µ –ø—Ä–æ–≤–µ—Ä–∫—É –≤ production:

```typescript
// –í lib/yookassa.ts
const YOOKASSA_IPS = [
  '185.71.76.0/27',
  '185.71.77.0/27',
  '77.75.153.0/25',
  '77.75.154.128/25',
]

function checkIPWhitelist(ip: string): boolean {
  // Implement IP range check
  return isIPInRanges(ip, YOOKASSA_IPS)
}
```

### Rate Limiting

Webhook endpoint –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å rate limiting:

```typescript
// –í /api/payment/webhook/yookassa/route.ts
import { checkRateLimit } from '@/lib/validation'

const ip = request.headers.get('x-forwarded-for') || 'unknown'
if (!checkRateLimit(ip, 'webhook-yookassa', 100)) {
  return NextResponse.json({ error: 'Too many requests' }, { status: 429 })
}
```

## –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

- **YooKassa API Docs**: https://yookassa.ru/developers/api
- **Webhooks Guide**: https://yookassa.ru/developers/using-api/webhooks
- **Test Cards**: https://yookassa.ru/developers/payment-acceptance/testing-and-going-live/testing
- **Integration Checklist**: https://yookassa.ru/developers/payment-acceptance/integration-checklist

## –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º:

1. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏: `vercel logs --follow`
2. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ë–î: SQL queries –≤—ã—à–µ
3. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å structured logs –≤ Vercel Dashboard
4. ‚úÖ –û–±—Ä–∞—Ç–∏—Ç—å—Å—è –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É YooKassa: support@yookassa.ru
5. ‚úÖ –°–æ–∑–¥–∞—Ç—å issue –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞

---

**Last Updated**: 2025-10-26  
**Version**: 1.0.0  
**Status**: ‚úÖ Ready for testing

